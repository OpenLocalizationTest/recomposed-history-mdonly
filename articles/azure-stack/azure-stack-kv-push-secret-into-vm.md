---
title: Deploy a virtual machine with a securely stored certificate on Azure Stack | Microsoft Docs
description: Learn how deploy a virtual machine and push a certificate onto it by using Key Vault in Azure Stack
services: azure-stack
documentationcenter: ''
author: SnehaGunda
manager: byronr
editor: ''

ms.assetid: 46590eb1-1746-4ecf-a9e5-41609fde8e89
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 06/06/2017
ms.author: sngun

---
# Create VMs and include certificates retrieved from a Key Vault

> [!NOTE]
> In Technical Preview 3, you can create and manage a key vault from the [user portal](azure-stack-manage-portals.md#the-user-portal) or user API only. If you are an administrator, sign in to the user portal to access and perform operations on a key vault.

## Prerequisites

* [Install PowerShell for Azure Stack.](azure-stack-powershell-install.md)  
* Azure Stack administrators must have [created an offer](azure-stack-create-offer.md) that includes the Key Vault service.  
* Tenants must [subscribe to an offer](azure-stack-subscribe-plan-provision-vm.md) that includes the Key Vault service. 

Key vault in Azure Stack is used to store certificates. Certificates are helpful in many different scenarios. For example, consider a scenario where you have a virtual machine in Azure Stack that is running an application, which needs a certificate. This certificate could be used for encrypting, for authenticating to Active Directory or for SSL on a website. Having the certificate in a Key Vault make sure that it is secure.

In this article, we walk you through the steps required to push a certificate onto a Windows virtual machine in Azure Stack. You can use these steps either from the Azure Stack POC computer, or from a Windows-based external client if you are connected through VPN.

## Include a certificate in the virtual machine

The following steps describe the process to push a certificate onto the virtual machine:

* Create a certificate.
* Create a Key Vault
* Upload the certificate into the key vault.
* Deploy a template to create a virtual machine and push the certificate onto it.

The following script creates a certificate in the .pfx format, creates a key vault, and stores the certificate within the key vault as a secret. The `-EnabledForDeployment` parameter must be used when creating the key vault, this parameter makes sure that the key vault can be referenced from Resource Manager templates.

```powershell

# Create a certificate in the .pfx format
New-SelfSignedCertificate `
  -certstorelocation cert:\LocalMachine\My `
  -dnsname contoso.microsoft.com

$pwd = ConvertTo-SecureString `
  -String "<Password used to export the certificate>" `
  -Force `
  -AsPlainText

Export-PfxCertificate `
  -cert "cert:\localMachine\my\<Your certificate Thumbprint>" `
  -FilePath "<Fully qualified path to the certificate>" `
  -Password $pwd

# Create a Key Vault and upload the certificate into the Key Vault as a secret
$vaultName = "contosovault"
$resourceGroup = "contosovaultrg"
$location = "local"
$secretName = "servicecert"
$fileName = "<Fully qualified path to the certificate>"
$certPassword = "<Password used to export the certificate>"

$fileContentBytes = get-content $fileName `
  -Encoding Byte

$fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)
$jsonObject = @"
{
"data": "$filecontentencoded",
"dataType" :"pfx",
"password": "$certPassword"
}
"@
$jsonObjectBytes = [System.Text.Encoding]::UTF8.GetBytes($jsonObject)
$jsonEncoded = [System.Convert]::ToBase64String($jsonObjectBytes)

New-AzureRmResourceGroup `
  -Name $resourceGroup `
  -Location $location

New-AzureRmKeyVault `
  -VaultName $vaultName `
  -ResourceGroupName $resourceGroup `
  -Location $location `
  -sku standard `
  -EnabledForDeployment

$secret = ConvertTo-SecureString `
  -String $jsonEncoded `
  -AsPlainText -Force

Set-AzureKeyVaultSecret `
  -VaultName $vaultName `
  -Name $secretName `
   -SecretValue $secret

```

When the previous script is executed, it outputs the secret URI, make a note of this URI. You have to reference this URI in the [Push certificate to Windows Resource Manager template](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-push-certificate-windows). download this template onto your development computer and modify the `azuredeploy.parameters.json` file as per your environment values. The parameters of special interest are the vault name, the vault resource group, and the secret URI(this value is generated by the previous script). The following file is an example of a parameters file:

```json
{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "newStorageAccountName": {
      "value": "kvstorage01"
    },
    "vmName": {
      "value": "VM1"
    },
    "vmSize": {
      "value": "Standard_D1_v2"
    },
    "adminUserName": {
      "value": "demouser"
    },
    "adminPassword": {
      "value": "demouser@123"
    },
    "vaultName": {
      "value": "contosovault"
    },
    "vaultResourceGroup": {
      "value": "contosovaultrg"
    },
    "secretUrlWithVersion": {
      "value": "<URI of the secret that was created in the previous section>"
    }
  }
}
```

Now deploy the template by using the following PowerShell script:

```powershell
# Deploy a Resource Manager template to create a VM and push the secret onto it
New-AzureRmResourceGroupDeployment `
  -Name KVDeployment `
  -ResourceGroupName $resourceGroup `
  -TemplateFile C:\Users\AzureStackAdmin\Desktop\Test\azuredeploy.json `
  -TemplateParameterFile C:\Users\AzureStackAdmin\Desktop\Test\azuredeploy.parameters.json
```

When the template is deployed successfully, it results in the following output:

![Deployment output](media\azure-stack-kv-push-secret-into-vm/deployment-output.png)

When this virtual machine is deployed, Azure Stack pushes the certificate onto the virtual machine. On Windows, the certificate is added to the LocalMachine certificate location, with the certificate store that the user provided. On Linux,
the certificate is placed under the /var/lib/waagent directory,
with the file name &lt;UppercaseThumbprint&gt;.crt for the X509
certificate file, and &lt;UppercaseThumbprint&gt;.prv for the private key.

## Retire certificates

In the preceding section, we showed you how to push a new certificate onto a virtual machine. But your old certificate is still in the virtual machine and it can't be removed. However, you can disable the older version of secret by using the `Set-AzureKeyVaultSecretAttribute` cmdlet. The following is an example usage of this cmdlet, make sure to replace the vault name, secret name, and version values as per your environment:

```powershell
Set-AzureKeyVaultSecretAttribute -VaultName contosovault -Name servicecert -Version e3391a126b65414f93f6f9806743a1f7 -Enable 0
```

## Next Steps

* [Deploy a VM with a Key Vault password](azure-stack-kv-deploy-vm-with-secret.md)

* [Allow an application to access Key Vault](azure-stack-kv-sample-app.md)


