<properties
	pageTitle="Job preparation and cleanup in Batch | Microsoft Azure"
	description="Employ job-level preparation tasks to minimize data transfer to Azure Batch compute nodes, and release tasks for node cleanup at job completion."
	services="batch"
	documentationCenter=".net"
	authors="mmacy"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="batch"
	ms.devlang="multiple"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows"
	ms.workload="big-compute"
	ms.date="10/15/2015"
	ms.author="v-marsma"/>

# Perform job preparation and completion maintenance in Azure Batch

Azure Batch jobs often require some form of set up prior to execution, and similarly, some sort of post-job maintenance after the job's tasks have completed. Batch provides the mechanisms for this preparation and maintenance in the form of *job preparation* and *job release* tasks.

Before executing of any of a job's tasks, the job preparation task is run all compute nodes scheduled to run tasks. Once the job has completed, the job release task is run on each of the nodes within the pool that executed at least one task. Both job preparation and release tasks allow for the specification of a command line to be executed when invoked, and feature capabilities such as file download and elevated execution as well as properties such as custom environment variables and maximum execution duration, retry count, and file retention time.

In the following sections, you'll find out how to use these two special task types using the [JobPreparationTask][net_job_prep] and [JobReleaseTask][net_job_release] found in the [Batch .NET][api_net] API.

> [AZURE.TIP] Job preparation and release tasks are especially helpful in "shared pool" environments--those environments in which a pool of compute nodes persists between job runs and is shared between many different jobs.

## When to use job preparation and release tasks

A number of situations benefit from the usage of job preparation and release tasks, here are just a few:

- **Transfer of common task data** - Batch jobs often require a common set of data as input for the job's tasks. For example, when performing daily risk analysis, market data is job-specific, yet common to all of the tasks in the job. This market data, often several gigabytes in size, should be downloaded to each compute node only once, then shared by each task executed on a node. Employing a *job preparation task* allows for the download of such data to each node prior to the execution of any tasks.
- **Job data deletion** - Within a shared pool environment in which a pool's compute nodes are not decommissioned between jobs, deleting job data between runs is necessary to prevent the pool's compute nodes from running out of disk space. It may also be done to satisfy an organization's security policy requiring minimal retention time of sensitive data. The *job release task* provides this capability, allowing for the deletion of data downloaded by a job preparation task or generated during task execution.
- **Log retention** - It is sometimes desirable to keep a copy of log files generated by tasks, or perhaps crash dump files generated by failed applications. A *job release task* could be used in such cases to compress and upload this data to an [Azure Storage][azure_storage] account.

## Job preparation tasks

Prior to the execution of a job's tasks, the job preparation task is executed on each compute node scheduled to run a task. By default, the Batch service will wait for the successful completion of the job preparation task prior to scheduling any tasks on the node, but may be configured not to wait. The job preparation task will be rerun on a compute node if the node is restarted, but this behavior may also be disabled.

The job preparation task is only executed on nodes scheduled to run a task. This prevents the unnecessary execution of a preparation task should a node not be assigned a task, providing savings in data transfer charges, for example. This situation applies when the number of tasks for a job is less than the number of nodes in a pool, or when [concurrent task execution](batch-parallel-node-tasks.md) is enabled, leaving some nodes idle if the task count is lower than the total possible concurrent tasks.

> [AZURE.NOTE] The [JobPreparationTask][net_job_prep_cloudjob] differs from the [CloudPool.StartTask][pool_starttask] in that the JobPreparationTask executes at the start of each job, whereas the StartTask executes only when a compute node first joins a pool or is restarted.

## Job release tasks

Once a job has completed, the job release task will be executed on each node in the pool that executed at least one task. A job is marked as completed by issuing a terminate request. When terminated, the Batch service sets the job state to *terminating*, terminates any active or running tasks associated with the job, and runs the job release task. The job then moves to the *completed* state.

> [AZURE.NOTE] Job deletion also executes the job release task. However, if a job was previously terminated, the release task is not run a second time when that job is subsequently deleted.

## Job preparation and release tasks in Batch .NET

Specifying a job preparation task is done by creating and configuring a [JobPreparationTask][net_job_prep] and assigning it to your job's [CloudJob.JobPreparationTask][net_job_prep_cloudjob] property. Similarly, initialize a [JobReleaseTask][net_job_release] and assign it to your job's [CloudJob.JobReleaseTask][net_job_prep_cloudjob] property to set the job's release task.

In this code snippet, `myBatchClient` is a fully initialized instance of [BatchClient][net_batch_client], and `myPool` is an existing pool within the Batch account.

		// Create the CloudJob for CloudPool "myPool"
		CloudJob myJob = myBatchClient.JobOperations.CreateJob("JobPrepReleaseSampleJob",
															   new PoolInformation() { PoolId = "myPool" });

		// Specify the command lines for the job preparation and release tasks
		string jobPrepCmdLine = "cmd /c echo %AZ_BATCH_NODE_ID% > %AZ_BATCH_NODE_SHARED_DIR%\\shared_file.txt";
		string jobReleaseCmdLine = "cmd /c del %AZ_BATCH_NODE_SHARED_DIR%\\shared_file.txt";

		// Assign the job preparation task to the job
		myJob.JobPreparationTask = new JobPreparationTask { CommandLine = jobPrepCmdLine };

		// Assign the job release task to the job
		myJob.JobReleaseTask = new JobPreparationTask { CommandLine = jobReleaseCmdLine };

		await myJob.CommitAsync();

As mentioned above, the release task is executed when a job is terminated or deleted. Terminating a job with the Batch .NET API is performed by calling [PoolOperations.TerminateJobAsync][net_job_terminate], and job deletion is performed with [PoolOperations.DeleteJobAsync][net_job_delete], both of which are typically done when a job's tasks have completed or a timeout you have defined has been reached.

		// Terminate the job to mark it as Completed; this will initiate the Job Release Task on any node
		// that executed job tasks. Note that the Job Release Task is also executed when a job is deleted,
		// thus you need not call Terminate if you typically delete your jobs upon task completion.
		await myBatchClient.JobOperations.TerminateJobAsync("JobPrepReleaseSampleJob");

## Next steps

### Sample project on GitHub

Check out the [JobPrepRelease][job_prep_release_sample] sample project on GitHub to see job preparation and release tasks in action. This console application:

1. Creates a pool with two "small" nodes
2. Creates a job with with job preparation, release, and standard tasks
3. The job preparation task first writes the node ID to a text file in a node's "shared" directory
4. Each task that runs on a node then writes its ID to the same text file
5. Once all tasks have completed (or the timeout is reached), the contents of each node's text file are printed to the console
6. When the job is complete, the job release task deletes the file from the node
6. The exit codes of the job prep and release tasks are then printed for each node on which they executed
7. Execution pauses to allow confirmation of job and/or pool deletion

Output from the sample application is similar to the following:

```
Attempting to create pool: JobPrepReleaseSamplePool
The pool already existed when we tried to create it
Checking for existing job JobPrepReleaseSampleJob...
Job JobPrepReleaseSampleJob not found, creating...
Submitting tasks and awaiting completion...
All tasks completed.

Contents of shared\job_prep_and_release.txt on tvm-3105992504_1-20151015t150030z:
-------------------------------------------
tvm-3105992504_1-20151015t150030z tasks:
  task001
  task002
  task006
  task007

Contents of shared\job_prep_and_release.txt on tvm-3105992504_2-20151015t150030z:
-------------------------------------------
tvm-3105992504_2-20151015t150030z tasks:
  task003
  task005
  task004
  task008

Waiting for job JobPrepReleaseSampleJob to reach state Completed
....

tvm-3105992504_1-20151015t150030z:
  Prep task exit code:    0
  Release task exit code: 0

tvm-3105992504_2-20151015t150030z:
  Prep task exit code:    0
  Release task exit code: 0

Delete job? [yes] no
yes
Delete pool? [yes] no
no

Sample complete, hit ENTER to exit...
```

### Inspect job preparation and release tasks with Batch Explorer

The [Batch Explorer][batch_explorer_article], also found in the Batch [sample code repository][batch_explorer_project] on Github, is an excellent tool for use when developing solutions with Azure Batch as it allows the inspection and manipulation of many aspects of your Batch environment. When running the above sample application, for example, you can use the Batch Explorer to view the properties of the job and its tasks, as even download the shared text file modified by the job's tasks.

The screenshot below highlights the job preparation and release task properties shown in the Job Details pane when the *JobPrepReleaseSampleJob* job is selected in the Jobs tab.

![Batch Explorer][1]

*Batch Explorer showing job preparation and release tasks*

[api_net]: http://msdn.microsoft.com/library/azure/mt348682.aspx
[api_net_listjobs]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.listjobs.aspx
[api_rest]: http://msdn.microsoft.com/library/azure/dn820158.aspx
[azure_storage]: https://azure.microsoft.com/services/storage/
[batch_explorer_article]: http://blogs.technet.com/b/windowshpc/archive/2015/01/20/azure-batch-explorer-sample-walkthrough.aspx
[batch_explorer_project]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/BatchExplorer
[job_prep_release_sample]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/JobPrepRelease
[net_batch_client]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.batchclient.aspx
[net_cloudjob]:https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.aspx
[net_job_prep]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobpreparationtask.aspx
[net_job_prep_cloudjob]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.jobpreparationtask.aspx
[net_job_delete]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.deletejobasync.aspx
[net_job_terminate]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.terminatejobasync.aspx
[net_job_release]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobreleasetask.aspx
[net_job_release_cloudjob]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.jobreleasetask.aspx
[pool_starttask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.starttask.aspx

[net_list_certs]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.certificateoperations.listcertificates.aspx
[net_list_compute_nodes]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.pooloperations.listcomputenodes.aspx
[net_list_job_schedules]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobscheduleoperations.listjobschedules.aspx
[net_list_jobprep_status]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.listjobpreparationandreleasetaskstatus.aspx
[net_list_jobs]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.listjobs.aspx
[net_list_nodefiles]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.listnodefiles.aspx
[net_list_pools]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.pooloperations.listpools.aspx
[net_list_schedule_jobs]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobscheduleoperations.listjobs.aspx
[net_list_task_files]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.listnodefiles.aspx
[net_list_tasks]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.joboperations.listtasks.aspx

[1]: ./media/batch-job-prep-release/batchexplorer-01.png
[2]: ./media/batch-job-prep-release/batchexplorer-02.png
