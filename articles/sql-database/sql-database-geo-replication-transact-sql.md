<properties
    pageTitle="Geo-Replication for Azure SQL Database using Transact-SQL"
    description="Geo-Replication for Azure SQL Database using Transact-SQL"
    services="sql-database"
    documentationCenter=""
    authors="carlrabeler"
    manager="jeffreyg"
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="NA"
    ms.workload="data-management"
    ms.date="09/19/2015"
    ms.author="carlrab"/>

# Geo-Replication for Azure SQL Database using Transact-SQL

**Single database**

> [AZURE.SELECTOR]
- [Azure Preview Portal](sql-database-geo-replication-portal.md)
- [PowerShell](sql-database-geo-replication-powershell.md)
- [Transact-SQL](sql-database-geo-replication-transact-sql.md)


This article shows you how to configure Geo-Replication for SQL Database with Transact-SQL.



> [AZURE.NOTE] Anything noteworthy?


To configure Geo-Replication you need the following:

- An Azure subscription - If you need an Azure subscription simply click **FREE TRIAL** at the top of this page, and then come back to finish this article.
- A logical Azure SQL Database server <MyLocalServer> and a SQL database <MyLocalDB> - The primary database that you want to replicate to a different geographical region.
- One or more logical Azure SQL Database servers <MySecondaryServer(n)> - The logical servers that will be the parter servers in which you will create geo-replication secondary databases
- A login that is DBManager on the primary, have db_ownership of the local database, and be DBManager on the partner server.
- Newest version of SQL Server Management Studio - To obtain the newest version of SQL Server Management Studio (SSMS), go to [Download SQL Server Management Studio] (https://msdn.microsoft.com/library/mt238290.aspx). For more information on using SQL Server Management Studio to manage an Azure SQL Database logical servers and databases, see [Managing Azure SQL Database using SQL Server Management Studio](sql-database-manage-azure-ssms.md)

## Connect to a SQL Database logical server

Connecting to SQL Database requires that you know the server name on Azure. You might need to sign in to the portal to get this information.

1.  Sign in to the [Azure Management Portal](http://manage.windowsazure.com).

2.  In the left pane, click **SQL Databases**.

3.  On the SQL Databases home page, click **SERVERS** at the top of the page to list all of the servers associated with your subscription. Find the name of the server to which you want to connect and copy it to the clipboard.

	Next, configure your SQL Database firewall to
allow connections from your local machine. You do this by adding your local machines IP address to the firewall exception list.

1.  On SQL Databases home page, click **SERVERS** and then click the server to which you want to connect.

2.  Click **Configure** at the top of the page.

3.  Copy the IP address in CURRENT CLIENT IP ADDRESS.

4.  In the Configure page, **Allowed IP Addresses** includes three boxes where you can specify a rule name and a range of IP addresses as starting and ending values. For a rule name, you might enter the name of your computer. For the start and end range, paste in the IP address of your computer into both boxes, and then click the checkbox that appears.

	The rule name must be unique. If this is your development computer, you can enter the IP address in both the IP range start box and the IP range end box. Otherwise, you might need to enter a broader range of IP addresses to accommodate connections from additional computers in your organization.

5. Click **SAVE** at the bottom of the page.

    **Note:** There can be up as much as a five-minute delay for changes
    to the firewall settings to take effect.

	You are now ready to connect to SQL Database using Management Studio.

1.  On the taskbar, click **Start**, point to **All Programs**, point to
    **Microsoft SQL Server 2014**, and then click **SQL Server
    Management Studio**.

2.  In **Connect to Server**, specify the fully-qualified
    server name  as *serverName*.database.windows.net. On Azure, the server name is an autogenerated string composed of alphanumeric characters.

3.  Select **SQL Server Authentication**.

4.  In the **Login** box, enter the SQL Server administrator login that you
    specified in the portal when you created  your server.

5.  In the **Password** box, enter the password that you specified in
    the portal when you created  your server.

8.  Click **Connect** to establish the connection.



## Add secondary database
You can use the **ALTER DATABASE** statement to add a secondary database on a partner server to a local database on the server to which you are connected (the primary database). The database on the secondary will have the same name as the database on the primary and will, by default, have the same SERVICE_OBJECTIVE. Furthermore, the secondary can be readable or non-readable, and can be a single database or an elastic databbase. For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/ms174269.aspx) and [Service Tiers](https://azure.microsoft.com/en-us/documentation/articles/sql-database-service-tiers/).
After the secondary is created and seeded, data will begin replicating from the primary database to the new secondary database. The steps below describe how to accomplish this task through Management Studio to create non-readable and readable secondaries, either with a single database or an elastic database.
> [AZURE.NOTE] If the secondary database exists on the specified parther server (for example, because a relationship already exists as a result of termination of a previous geo-replication relationship) the command will fail.

### Add non-readable secondary (single database)
1. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

2. Use the following **ALTER DATABASE** statement to make <MyLocalDB> into a geo-replication primary with a non-readable secondary database on <MySecondaryServer1>.

        ALTER DATABASE <MyLocalDB>
           ADD SECONDARY ON SERVER <MySecondaryServer1> WITH ALLOW_CONNECTIONS = NO);

3. Click **Execute** to run the query.

### Add readable secondary (single database)
1. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

2. Use the following **ALTER DATABASE** statement to make <MyLocalDB> into a geo-replication primary with a readable secondary database on <MySecondaryServer2>.

        ALTER DATABASE <MyLocalDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH ALLOW_CONNECTIONS = ALL);

3. Click **Execute** to run the query.
### Add non-readable secondary (elastic database)
1. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

2. Use the following **ALTER DATABASE** statement to make <MyLocalDB> into a geo-replication primary with a non-readable secondary database on <MySecondaryServer3> in <ElasticPool1>.

        ALTER DATABASE <MyLocalDB>
           ADD SECONDARY ON SERVER <MySecondaryServer3> WITH ALLOW_CONNECTIONS = NO)
           , ELASTIC_POOL (name = 'ElasticPool1');

3. Click **Execute** to run the query.

### Add readable secondary (elastic database)
1. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

2. Use the following **ALTER DATABASE** statement to make <MyLocalDB> into a geo-replication primary with a readable secondary database on <MySecondaryServer4> in <ElasticPool2>.

        ALTER DATABASE <MyLocalDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH ALLOW_CONNECTIONS = NO)
           , ELASTIC_POOL (name = 'ElasticPool2');

3. Click **Execute** to run the query.


## Remove secondary database

The operation permanently terminates the replication to the secondary database and change the role of the secondary to the regular read-write database. If the connectivity to secondary database is broken the command succeeds but the secondary will become read-write after connectivity is restored.  




## Initiate a planned failover from the primary database to the secondary database

The secondary database can be switched to primary and vice versa. It is designed for planned failover such as during the DR drills. The command performs the following workflow:

1. Temporarily switch replication to synchronous mode. This will cause all outstanding transactions to be flushed to the secondary;

2. Switch the roles of the two databases in the geo-replication relationship.  

This sequence guarantees that no data loos will occur. There is a short period during which both databases are unavailable (on the order of 0 to 25 seconds) while the roles are switched. The entire operation should take less than a minute to complete under normal circumstances.

NOTE:  If the primary database is unavailable when the command is issued it will fail with the error message indicating that the primary server is not available. In rare cases it is possible that the operation cannot complete and may appear stuck. In this case the user can call the force failover command and accept data loss.




## Initiate an unplanned failover from the primary database to the secondary database

### Cleanup

### Allow/disallow data loss


In the case on an outage when the primary is no longer available the secondary database can be switched to primary using forced failover. It is designed for disaster recovery when restoring availability of the database is critical and some data loss is acceptable.  

When forced failover is invoked, the specified secondary database immediately becomes a primary database and begins accepting write transactions. As soon as the original primary database is able to reconnect with this new primary database after the forced failover operation, an incremental backup is taken on the original primary database and it is made into a secondary for the new primary database; subsequently, it is merely a replica of the new primary. But because Point In Time Restore is not supported on the secondary databases, if the user wishes to recovery data committed to the old primary database which had not been replicated to the new primary database, she has to engage CSS to restore a database to the know log backup.

NOTE: If the command is issued when the both primary and secondary are online the old primary will become the new secondary but data synchronization will not be attempted. So some data loss may occur.


If the primary database has multiple secondaries the command will partially succeed. The secondary on which the command was executed will become primary. The old primary however will remain primary, i.e. the two primaries will end up in inconsistent state and connected by a suspended replication link. The user will have to manually repair this configuration using a “remove secondary” API on either of these primary databases.




## Monitor Geo-Replication configuration and health

Monitoring tasks include monitoring of the geo-replication configuration and monitoring data replication health.  




## Copy a database

A new database is created in the same or different logical server using a default or user selected service objective, including a named elastic pool.  


## Monitor a database copy

Since the database copy process is asynchronous the user can monitor the copy state transitions and the completion time.  



## Setup Geo-Replication Transact-SQL script


    Some T-SQL here?





## Next steps

- [Disaster Recovery Drills](sql-database-disaster-recovery-drills.md)




## Additional resources

- [Business Continuity Overview](sql-database-business-continuity.md)
- [SQL Database documentation](https://azure.microsoft.com/documentation/services/sql-database/)
