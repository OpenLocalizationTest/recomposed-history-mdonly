<properties
	pageTitle="Prepare Asianux VHD for Azure."
	description="Learn how to create the Asinux VHD file."
	services="virtual-machines"
	documentationCenter=""
	authors="SuperScottz"
	manager="timlt"
	editor=""/>

<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="article"
	ms.date="11/23/2015"
	ms.author="mingzhan"/>




#Prepare Asianux VHD for Azure##Prerequisites“Asianux Server” is an Enterprise Linux OS developed by [MIRACLE LINUX CORPORATION](http://www.miraclelinux.com/), an unique Linux distributor in Japan. It is adopted as various system integration for more than 15 years, and possesses many results. This topic assumes that you have already installed an Aisanux Linux operating system from ISO file on [Asianux website](http://www.asianux.com/node/1) to a virtual hard disk. Multiple tools exist to create .vhd files, for example a virtualization solution such as Hyper-V. For instructions, see Install the Hyper-V Role and Configure a Virtual Machine. 
**Installation Notes**•	The newer VHDX format is not supported in Azure. You can convert the disk to VHD format using Hyper-V Manager or the convert-vhd cmdlet.•	When installing the Linux system it is recommended that you use standard partitions rather than LVM (often the default for many installations). This will avoid LVM name conflicts with cloned VMs, particularly if an OS disk ever needs to be attached to another VM for troubleshooting. LVM or RAID may be used on data disks if preferred.•	Do not configure a swap partition on the OS disk. The [Azure Linux agent](virtual-machines-linux-agent-user-guide) can be configured to create a swap file on the temporary resource disk. More information about this can be found in the steps below.•	All of the VHDs must have sizes that are multiples of 1 MB.##Asianux 41.	In Hyper-V Manager, select the virtual machine.2.	Click **Connect** to open a console window for the virtual machine.3.	Uninstall **NetworkManager** (if it’s installed) by running the following command:        # sudo rpm -e --nodeps NetworkManager4.	Create a file named **network** in the `/etc/sysconfig/` directory that contains the following text:        NETWORKING=yes        HOSTNAME=localhost.localdomain5.	Create a file named **ifcfg-eth0** in the `/etc/sysconfig/network-scripts/ directory` that contains the following text:        DEVICE=eth0        ONBOOT=yes        BOOTPROTO=dhcp        TYPE=Ethernet        USERCTL=no        PEERDNS=yes        IPV6INIT=no        6.	Move (or remove) udev rules to avoid generating static rules for the Ethernet interface. These rules cause problems when cloning a virtual machine in Microsoft Azure or Hyper-V:              # sudo mkdir -m 0700 /var/lib/waagent        # sudo mv /lib/udev/rules.d/75-persistent-net-generator.rules /var/lib/waagent/        # sudo mv /etc/udev/rules.d/70-persistent-net.rules /var/lib/waagent/7.	Ensure the network service will start at boot time by running the following command:
        # sudo chkconfig network on        8.	Modify the kernel boot line in your grub configuration to include additional kernel parameters for Azure. To do this open `/boot/grub/menu.lst` in a text editor and ensure that the default kernel includes the following parameters:        console=ttyS0 earlyprintk=ttyS0 rootdelay=300 numa=off
    This will also ensure all console messages are sent to the first serial port, which can assist Azure support with debugging issues. This will disable **NUMA** due to a bug in the kernel version used by RHEL 6.    In addition to the above, it is recommended to remove the following parameters:        rhgb quiet crashkernel=auto
        Graphical and quiet boot are not useful in a cloud environment where we want all the logs to be sent to the serial port.    The crashkernel option may be left configured if desired, but note that this parameter will reduce the amount of available memory in the VM by **128MB** or more, which may be problematic on the smaller VM sizes.9.	Ensure that the SSH server is installed and configured to start at boot time. This is usually the default. Modify the `/etc/ssh/sshd_config` to include following line:        ClientAliveInterval 18010.	Install **python-pyasn1** package from the installation ISO:                   # rpm –ivh python-pyasn1-0.0.12a-1.AXS4.noarch.rpm        11.	Install Azure Linux Agent from Github through [guidance](virtual-machines-linux-update-agent), and choose the version 2.0.15:        # wget https://raw.githubusercontent.com/Azure/WALinuxAgent/WALinuxAgent-2.0.15/waagent        # chmod +x waagent        # cp waagent /usr/sbin        # /usr/sbin/waagent -install -verbose
12.	Make sure service waagent can be started successfully        # sudo service waagent start        # sudo service waagent status
14.	Do not create swap space on the OS diskThe Azure Linux Agent can automatically configure swap space using the local resource disk that is attached to the VM after provisioning on Azure. Note that the local resource disk is a temporary disk, and might be emptied when the VM is deprovisioned. After installing the Azure Linux Agent (see previous step), modify the following parameters in /etc/waagent.conf appropriately:        ResourceDisk.Format=y        ResourceDisk.Filesystem=ext4        ResourceDisk.MountPoint=/mnt/resource        ResourceDisk.EnableSwap=y        ResourceDisk.SwapSizeMB=2048    ## NOTE: set this to whatever you need it to be.
15.	Run the following commands to deprovision the virtual machine and prepare it for provisioning on Azure:        # sudo waagent -force -deprovision        # export HISTSIZE=0        # logout
16.	Click **Action -> Shut Down** in Hyper-V Manager. Your Linux VHD is now ready to be uploaded to Azure.##Asianux 71.	In Hyper-V Manager, select the virtual machine.2.	Click **Connect** to open a console window for the virtual machine.3.	Create a file named network in the `/etc/sysconfig/` directory that contains the following text:        NETWORKING=yes        HOSTNAME=localhost.localdomain
      4.	Create a file named **ifcfg-eth0** in the `/etc/sysconfig/network-scripts/` directory that contains the following text:        DEVICE=eth0        ONBOOT=yes        BOOTPROTO=dhcp        TYPE=Ethernet        USERCTL=no        PEERDNS=yes        IPV6INIT=no
      5.	Ensure the network service will start at boot time by running the following command:        # sudo chkconfig network on
      6.	Modify the kernel boot line in your grub configuration to include additional kernel parameters for Azure. To do this open `/etc/default/grub` in a text editor and edit the **GRUB_CMDLINE_LINUX** parameter, for example:        GRUB_CMDLINE_LINUX="rootdelay=300 console=ttyS0 earlyprintk=ttyS0"
           This will also ensure all console messages are sent to the first serial port, which can assist Azure support with debugging issues. In addition to the above, it is recommended to remove the following parameters:        rhgb quiet crashkernel=auto
           Graphical and quiet boot are not useful in a cloud environment where we want all the logs to be sent to the serial port.    The crashkernel option may be left configured if desired, but note that this parameter will reduce the amount of available memory in the VM by **128MB** or more, which may be problematic on the smaller VM sizes.7.	Once you are done editing `/etc/default/grub` per above, run the following command to rebuild the grub configuration:        # sudo grub2-mkconfig -o /boot/grub2/grub.cfg
8.	Ensure that the SSH server is installed and configured to start at boot time. This is usually the default. Modify the `/etc/ssh/sshd_config` to include following line:        ClientAliveInterval 180
9.	Install the **python-pyasn1** package.
             # yum update install python-pyasn110.	Install Azure Linux Agent from Github through [guidance](virtual-machines-linux-update-agent), and choose the version 2.0.15:
        # wget https://raw.githubusercontent.com/Azure/WALinuxAgent/WALinuxAgent-2.0.15/waagent        # chmod +x waagent        # cp waagent /usr/sbin        # /usr/sbin/waagent -install -verbose        11.	Enable waagent.service        # systemctl enable waagent.service        12.	Do not create swap space on the OS disk. The Azure Linux Agent can automatically configure swap space using the local resource disk that is attached to the VM after provisioning on Azure. Note that the local resource disk is a temporary disk, and might be emptied when the VM is deprovisioned. After installing the Azure Linux Agent (see previous step), modify the following parameters in `/etc/waagent.conf` appropriately:        ResourceDisk.Format=y        ResourceDisk.Filesystem=ext4        ResourceDisk.MountPoint=/mnt/resource        ResourceDisk.EnableSwap=y        ResourceDisk.SwapSizeMB=2048    ## NOTE: set this to whatever you need it to be.        13.	Run the following commands to deprovision the virtual machine and prepare it for provisioning on Azure:        # sudo waagent -force -deprovision        # export HISTSIZE=0        # logout
14.	Click **Action -> Shut Down** in Hyper-V Manager. Your Linux VHD is now ready to be uploaded to Azure.
##More about Asianux on Azure
Actually, Asianux Linux 4SP4 & 7 have been offically on-boarded in Azure Makertplace already. You could create an Asianux VM from Azure Marketplace directly if this is the 1st time you use Asianux in Azure, see the [Asinux4 announcement](http://blogs.msdn.com/b/ayatokura/archive/2015/09/07/asianux-server-on-microsoft-azure.aspx) and  [Asianux guidance on Azure by MiracleLinux](http://www.miraclelinux.com/lp/ax-azure-trial). 