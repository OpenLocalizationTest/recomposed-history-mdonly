<properties 
	pageTitle="Use Mobile Services to upload images to blob storage (Android) | Mobile Services" 
	description="Learn how to use Mobile Services to upload images to Azure Blob Storage and access the images from your Android app." 
	services="mobile-services" 
	documentationCenter="windows" 
	authors="RickSaling" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile-android" 
	ms.devlang="java" 
	ms.topic="article" 
	ms.date="07/09/2015" 
	ms.author="ricksal"/>

# Upload images from Android device to Azure Storage

[AZURE.INCLUDE [mobile-services-selector-upload-data-blob-storage](../../includes/mobile-services-selector-upload-data-blob-storage.md)]

This topic shows you how to use Azure Mobile Services to enable your Android app to upload and store user-generated images in Azure Storage. Mobile Services uses a SQL Database to store data. However, binary large object (BLOB) data is more efficiently stored in Azure Blob storage service. 

You cannot securely distribute with the client app the credentials required to securely upload data to the Blob Storage service. Instead, you must store these credentials in your mobile service and use them to generate a Shared Access Signature (SAS) that is used to upload a new image. The SAS, a credential with a short expiration--in this case 5 minutes, is returned securely by Mobile Services to the client app. The app then uses this temporary credential to upload the image. In this example, downloads from the Blob service are public.

In this tutorial you add functionality to the Mobile Services quickstart app to take pictures and upload the images to Azure by using a SAS generated by Mobile Services. 


## What you need to get started

This tutorial is based on the Mobile Services quickstart. Before you start this tutorial, you must first complete [Get started with Mobile Services]. 

This tutorial also requires the following:

+ An [Azure Storage account](../storage-create-storage-account.md)
+ A camera or other image capture device attached to your computer.

## Update the registered insert script in the Management Portal

[AZURE.INCLUDE [mobile-services-configure-blob-storage](../../includes/mobile-services-configure-blob-storage.md)]

[AZURE.INCLUDE [mobile-services-windows-store-dotnet-upload-to-blob-storage](../../includes/mobile-services-windows-store-dotnet-upload-to-blob-storage.md)]



## Update the quickstart app to capture and upload images.

### Reference the Storage client for Android apps

1. To upload images to Blob storage, first add the reference to the Storage client library for Android apps. In the **app** **build.gradle** file, add this line to the `dependencies` section:

		compile 'com.microsoft.azure.android:azure-storage-android:0.5.1@aar'


2. Change the `minSdkVersion` value to 15 (required by the camera API).

### Update the manifest for camera and storage

Specify your app depends on having a camera,and needs permission to write to external storage by adding these lines to **AndroidManifest.xml**:

	    <uses-feature android:name="android.hardware.camera"
	        android:required="true" />
	    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />

### Update resource files for the new user interface

1. Add titles for new buttons by adding the following to the **strings.xml** file in the *values* directory:

	    <string name="preview_button_text">Preview</string>
	    <string name="upload_button_text">Upload</string>

2. In the **activity_to_do.xml** file in the **res => layout** folder,  add the following button code before the existing code for the **Add** button.

         <Button
             android:id="@+id/buttonPreview"
             android:layout_width="120dip"
             android:layout_height="wrap_content"
             android:onClick="previewPhoto"
             android:text="@string/preview_button_text" />

3. Replace the **Add** button element with the following code:

         <Button
             android:id="@+id/buttonUpload"
             android:layout_width="100dip"
             android:layout_height="wrap_content"
             android:onClick="uploadPhoto"
             android:text="@string/upload_button_text" />

4. In **ToDoActivity.java**, rename the **addItem** method to **upLoadPhoto**.


### Add code for photo capture




1. Add this code to create a **File** object with a unique name where the photo image will be stored.

		// Create a File object for storing the photo
		String mCurrentPhotoPath;
	
	    private File createImageFile() throws IOException {
	        // Create an image file name
	        String timeStamp = new SimpleDateFormat("yyyyMMdd_HHmmss").format(new Date());
	        String imageFileName = "JPEG_" + timeStamp + "_";
	        File storageDir = Environment.getExternalStoragePublicDirectory(
	                Environment.DIRECTORY_PICTURES);
	        File image = File.createTempFile(
	                imageFileName,  /* prefix */
	                ".jpg",         /* suffix */
	                storageDir      /* directory */
	        );
	
	        // Save a file: path for use with ACTION_VIEW intents
	        mCurrentPhotoPath = "file:" + image.getAbsolutePath();
	        return image;
	    }

5. Add this code that will start up the Android camera app. You can then take a picture, and when it looks OK, press **Save**, and that will store it in the file you just created.

			// Run an Intent to start up the Android camera
		    static final int REQUEST_TAKE_PHOTO = 1;
		
		    private void takePicture() {
		        Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
		        // Ensure that there's a camera activity to handle the intent
		        if (takePictureIntent.resolveActivity(getPackageManager()) != null) {
		            // Create the File where the photo should go
		            File photoFile = null;
		            try {
		                photoFile = createImageFile();
		            } catch (IOException ex) {
		                // Error occurred while creating the File
		                //
		            }
		            // Continue only if the File was successfully created
		            if (photoFile != null) {
		                Uri mPhotoFile = Uri.fromFile(photoFile);
		//                takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, mPhotoFile);
		                startActivityForResult(takePictureIntent, REQUEST_TAKE_PHOTO);
		            }
		        }
		    }


### Add code to upload photo file to blob storage

Uploading the photo is a multistep process:

- add a record to the SQL database that contains new fields describing the blob storage.
- Ask blob storage for a SAS, in the mobile service backend SQL insert script.
- In that script, return the SAS and location information to the client.
- In the client, upload the photo, using the SAS and blob URI.

<!- -->


1. First we add properties to the `ToDoItem` object by adding this code to **ToDoItem.java**.

		/**
	     *  imageUri - points to location in storage where photo will go
	     */
	    @com.google.gson.annotations.SerializedName("imageUri")
	    private String mImageUri;
	
	    /**
	     * Returns the item ImageUri
	     */
	    public String getImageUri() {
	        return mImageUri;
	    }
	
	    /**
	     * Sets the item ImageUri
	     *
	     * @param ImageUri
	     *            Uri to set
	     */
	    public final void setImageUri(String ImageUri) {
	        mImageUri = ImageUri;
	    }
	
	    /**
	     * ContainerName - like a directory, holds blobs
	     */
	    @com.google.gson.annotations.SerializedName("containerName")
	    private String mContainerName;
	
	    /**
	     * Returns the item ContainerName
	     */
	    public String getContainerName() {
	        return mContainerName;
	    }
	
	    /**
	     * Sets the item ContainerName
	     *
	     * @param ContainerName
	     *            Uri to set
	     */
	    public final void setContainerName(String ContainerName) {
	        mContainerName = ContainerName;
	    }
	
	    /**
	     *  ResourceName
	     */
	    @com.google.gson.annotations.SerializedName("resourceName")
	    private String mResourceName;
	
	    /**
	     * Returns the item ResourceName
	     */
	    public String getResourceName() {
	        return mResourceName;
	    }
	
	    /**
	     * Sets the item ResourceName
	     *
	     * @param ResourceName
	     *            Uri to set
	     */
	    public final void setResourceName(String ResourceName) {
	        mResourceName = ResourceName;
	    }
	
	    /**
	     *  SasQueryString - permission to write to storage
	     */
	    @com.google.gson.annotations.SerializedName("sasQueryString")
	    private String mSasQueryString;
	
	    /**
	     * Returns the item SasQueryString
	     */
	    public String getSasQueryString() {
	        return mSasQueryString;
	    }
	
	    /**
	     * Sets the item SasQueryString
	     *
	     * @param SasQueryString
	     *            Uri to set
	     */
	    public final void setSasQueryString(String SasQueryString) {
	        mSasQueryString = SasQueryString;
	    }

### Archive

TBD: delete this stuff

6. Add this code at the end of the `try` block in the `onCreate` method. This code enables the **previewButton** to take the photos.

            Button previewButton = (Button) this.findViewById(R.id.buttonPreview);
            previewButton.setOnClickListener(new View.OnClickListener() {

                @Override
                public void onClick(View v) {
                    takePictureIntent();
		//          simplePix();


## <a name="next-steps"> </a>Next steps

Now that you have been able to securely upload images by integrating your mobile service with the Blob service, check out some of the other backend service and integration topics:

+ [Send email from Mobile Services with SendGrid]
 
  Learn how to add email functionality to your Mobile Service using the SendGrid email service. This topic demonstrates how to add server side scripts to send email using SendGrid.

+ [Schedule backend jobs in Mobile Services]

  Learn how to use the Mobile Services job scheduler functionality to define server script code that is executed on a schedule that you define.

+ [Mobile Services server script reference]

  Reference topics for using server scripts to perform server-side tasks and integration with other Azure components and external resources.
 
+ [Mobile Services .NET How-to Conceptual Reference]

  Learn more about how to use Mobile Services with .NET
  
 
<!-- Anchors. -->
[Install the Storage Client library]: #install-storage-client
[Update the client app to capture images]: #add-select-images
[Update the insert script to generate an SAS]: #update-scripts
[Upload images to test the app]: #test
[Next Steps]:#next-steps

<!-- Images. -->

[2]: ./media/mobile-services-windows-store-dotnet-upload-data-blob-storage/mobile-add-storage-nuget-package-dotnet.png


<!-- URLs. -->
[Send email from Mobile Services with SendGrid]: store-sendgrid-mobile-services-send-email-scripts.md
[Schedule backend jobs in Mobile Services]: mobile-services-schedule-recurring-tasks.md
[Send push notifications to Windows Store apps using Service Bus from a .NET back-end]: http://go.microsoft.com/fwlink/?LinkId=277073&clcid=0x409
[Mobile Services server script reference]: mobile-services-how-to-use-server-scripts.md
[Get started with Mobile Services]: mobile-services-javascript-backend-windows-store-dotnet-get-started.md

[Azure Management Portal]: https://manage.windowsazure.com/
[How To Create a Storage Account]: ../storage-create-storage-account.md
[Azure Storage Client library for Store apps]: http://go.microsoft.com/fwlink/p/?LinkId=276866 
[Mobile Services .NET How-to Conceptual Reference]: mobile-services-windows-dotnet-how-to-use-client-library.md
[App settings]: http://msdn.microsoft.com/library/windowsazure/b6bb7d2d-35ae-47eb-a03f-6ee393e170f7
 