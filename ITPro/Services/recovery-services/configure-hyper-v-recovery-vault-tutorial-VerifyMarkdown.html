<html>
    <head>
        <title></title>
    </head>
    <body>
<p><div chunk="../chunks/recoveryservices-left-nav.md"/> </p>

<h1><a id="configure-hyper-v-recovery-vault-tutorial"></a>Configure Windows Azure Recovery Services to provide a Hyper-V recovery environment</h1>

<div class="dev-callout"> 
<strong>Note</strong>

<p>To complete this tutorial, you need a Windows Azure account that has the Windows Azure Recovery Services feature enabled.</p>
<ul> 
<li>If you don't have an account, you can create a free trial account in just a couple of minutes. For details, see <a href="/en-us/pricing/free-trial/">Windows Azure Free Trial</a>.</li> 

<li>If you have an existing account but need to enable the Windows Azure Recovery Services preview, see <a href="/en-us/develop/net/tutorials/create-a-windows-azure-account/#enable" target="_blank">Enable Windows Azure preview features</a>.</li>
</ul>
</div>

<p>A Hyper-V Recovery Manager vault defines a collection of Hyper-V virtual machines located in clouds on System Center 2012 Virtual Machine Manager (VMM) servers that are enabled for failover and protection using Windows Azure Recovery Services. This tutorial will walk you through the creation of the vault, the uploading of a certificate to the vault, the download and installation of the agent, and configuration tasks performed through the management portal.</p>

<div class="dev-callout"> 
<strong>Before you begin</strong> 
<p>To successfully complete this tutorial you must have 
an X.509 v3 certificate to register your servers with Recovery Services vaults.  The certificate must have a key length of at least 2048 bits and should reside in the Personal certificate store of your Local Computer. When the certificate is installed on your server, it should contain the private key of the certificate. To upload to the certificate to the Windows Azure Management Portal, you must export the public key as a .cer format file.</p> 

<p>You can either use:</p> 
<ul>
<li>Your own self-signed certificate created using makecert tool, OR</li> 

<li>Any valid SSL certificate issued by a Certificate Authority (CA) that is trusted by Microsoft and whose root certificates are distributed via the Microsoft Root Certificate Program. For more information about this program see <a href="http://go.microsoft.com/fwlink/p/?LinkId=294666">Windows Root Certificate Program members</a>.</li>
</ul> 

<p>Some other attributes which you need to ensure on the certificates are:</p> 

<ul>
<li>Has a valid ClientAuthentication EKU</li>

<li>Is currently valid with a validity period that does not exceed 3 years</li>  
</ul>

<p>To use your own self-signed certificate, follow these steps: </p>
<ol>
<li>Download the <a href="http://go.microsoft.com/fwlink/p/?LinkID=294662">Certificate Creation tool (MakeCert.exe)</a>.</li>  


<li>Open Command Prompt (cmd.exe) with Administrator privileges and run the following command, replacing <i>CertificateName</i> with the name of your certificate and specifying the actual expiration date of your certificate after -e:
<code>
makecert.exe -r -pe -n CN=CertificateName -ss my -sr localmachine -eku 1.3.6.1.5.5.7.3.2 -len 2048 -e 01/01/2016 CertificateName.cer</code></li>
</ol>
<p>
If you will be registering a different server than the one you used to make the certificate, you need to export the .pfx file (that contains the private key), copy it to the other server and import it to that serverâ€™s Personal certificate store. 
</p> 
</div>

<h2><a id="create"></a>Create a vault</h2>

<ol>
<li><p>Sign in to the <a href="https://manage.windowsazure.com">Management Portal</a>.</p>

<p><div chunk="../../Shared/Chunks/disclaimer.md"/></p></li>
<li><p>Click <strong>Recovery Services</strong>, then click <strong>Create New</strong>,  point to <strong>Hyper-V Recovery Manager Vault</strong>, and then click <strong>Quick Create</strong>.</p>

<p><img src="../media/RS_hvvault.png" alt="New vault" /></p></li>
<li><p>In <strong>Name</strong>, enter a friendly name to identify the backup vault.</p></li>
<li><p>In <strong>Region</strong>, select the geographic region for the backup vault.  </p></li>
<li><p>Click <strong>Create vault</strong>.</p>

<p>It can take a while for the vault to be created. To check the status, you can monitor the notifications at the bottom of the portal. After the vault has been created, a message will tell you that the vault has been successfully created and it will be listed in the resources for Recovery Services as <strong>Online</strong>. </p></li>
</ol>

<h2><a id="upload"></a>Upload a certificate</h2>

<ol>
<li><p>Sign in to the <a href="https://manage.windowsazure.com">Management Portal</a>.</p></li>
<li><p>Click <strong>Recovery Services</strong>, then click the name of vault that will be identified by the certificate and then click <strong>Manage certificate</strong>.</p>

<p><img src="../media/RS_howtoupload1.png" alt="Manage certificate" /></p></li>
<li>In the <strong>Manage Certificate</strong> dialog click Browse Your Computer to locate the .cer file to use with this backup vault.</li>
</ol>

<h2><a id="download"></a>Download and install the agent</h2>

<ol>
<li><p>Sign in to the <a href="https://manage.windowsazure.com">Management Portal</a>.</p></li>
<li><p>Click <strong>Recovery Services</strong>, then click the name of vault to view the vault dashboard.</p></li>
<li><p>Click <strong>Download Agent</strong>. The agent will be automatically download and the installation wizard will start.</p>

<p><img src="../media/RS_installwiz.png" alt="Download Agent" /></p></li>
<li>Complete the wizard to register the VMM server, identify the private key certificate on the VMM server that matches the public key certificate you uploaded to the vault, and then associate this VMM server with a specific vault. </li>
</ol>

<h2><a id="manage"></a>Configure clouds for protection</h2>

<p>After VMM servers are registered, all clouds configured on the servers are displayed in the vault.  When you select a cloud to protect, you specify the following configuration details in the management portal: </p>

<ul>
<li>The target location that will be used for failover of virtual machines in the source cloud.</li>
<li>How initial replication of data from the source to target locations will be handled.</li>
<li>How often to create data checkpoints.<br />
After you select a cloud, all clusters and host servers that are configured in the source and target clouds are configured for replication. Specifically:</li>
<li>Firewall rules used by Hyper-V Replica are configured.</li>
<li>Ports for replication traffic are opened.</li>
<li>Certificates required for replication are installed.</li>
<li>Hyper-V Replica settings are configured.</li>
</ul>

<h2><a id="networks"></a>Configure Networks</h2>

<p>You can map VM networks in source VMM servers to VM networks in target VMM server, to ensure that replica virtual machines are connected to appropriate networks.</p>

<ol>
<li><p>Sign in to the <a href="https://manage.windowsazure.com">Management Portal</a>.</p></li>
<li><p>Click <strong>Recovery Services</strong>, then click the name of vault that contains the VMM servers for which you want to configure network mapping.</p></li>
<li><p>Click <strong>Resources</strong> and then click <strong>Networks</strong></p></li>
<li><p>Select the source VMM server and then the target VMM server.</p></li>
<li><p>Select an item from <strong>Network on source</strong> and then click <strong>Map</strong>. </p>

<p><img src="../media/RS_networks.png" alt="Manage certificate" /></p></li>
<li><p>In the dialog that is displayed, select one of the VM networks from the target VMM server. </p></li>
<li><p>Click the information icon next to the source and target network names to view the subnets and type for each network.</p>

<p>When you select a target network, the protected clouds that use the source network are displayed. Availability of target networks associated with the clouds used for protection is also displayed. It is recommended that you select a target network that is available to all clouds used for protection.</p></li>
<li><p>Click the checkmark to complete the mapping process.</p>

<p>This will connect any existing replica virtual machines corresponding to the virtual machines connected to the source VM network to the target VM network. This will also connect new replica virtual machines that are created after enabling replication on the virtual machines connected to the source VM network to the target VM network.</p></li>
</ol>

<h2><a id="protect"></a>How to: Protect virtual machines</h2>

<p>After servers, clouds, and networks are configured correctly, you can enable virtual machines in the cloud for recovery and failover. Protection is enabled in the VMM console, by selecting the <strong>Enable Replication</strong> checkbox for each virtual machine you want to protect. Once the virtual machines are replicated to the vault you will be able to view them in the virtual machines list of your cloud.</p>

<p><img src="../media/RS_clouds.png" alt="Manage certificate" /></p>

<h2><a id="next"></a>Next steps</h2>

<ul>
<li><a href="http://go.microsoft.com/fwlink/p/?LinkId=290953">Create a recovery plan</a> to group virtual machines together for the purposes of failover and recovery. </li>
<li>To learn more about Windows Azure Recovery Services, see <a href="http://www.windowsazure.com/">Introducing Windows Azure Recovery Services</a>. </li>
<li>Visit the <a href="http://go.microsoft.com/fwlink/p/?LinkId=290933">Windows Azure Recovery Services Forum</a>.</li>
</ul>
    </body>
</html>
